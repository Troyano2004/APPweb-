<section class="module-page">
  <header class="module-header">
    <div>
      <h1>Registrar propuesta</h1>
      <p>Presenta tu propuesta de titulación para revisión de la comisión.</p>
    </div>
  </header>

  <div class="alert error" *ngIf="error()">{{ error() }}</div>
  <div class="alert ok" *ngIf="ok()">{{ ok() }}</div>

  <article class="card modalidad-card" *ngIf="estadoModalidad() as estado">
    <h2>Paso 1: Modalidad de titulación</h2>

    <div class="alert ok" *ngIf="estado.tieneModalidad">
      Modalidad registrada: <strong>{{ estado.modalidad }}</strong>. Ya puedes continuar con tu propuesta.
    </div>

    <div class="modalidad-form" *ngIf="!estado.tieneModalidad">
      <p class="hint">
        Para enviar tu propuesta primero debes escoger una modalidad de titulación.
      </p>

      <label>Selecciona modalidad
        <select [ngModel]="modalidadSeleccionada()" (ngModelChange)="modalidadSeleccionada.set($event)">
          <option [ngValue]="null">-- Selecciona una modalidad --</option>
          <option *ngFor="let modalidad of estado.modalidadesDisponibles" [ngValue]="modalidad.idModalidad">
            {{ modalidad.nombre }}
          </option>
        </select>
      </label>

      <small *ngIf="estado.modalidadesDisponibles.length === 0" class="warn-inline">
        No hay modalidades activas para tu carrera. Comunícate con coordinación.
      </small>

      <button class="btn primary" (click)="guardarModalidad()" [disabled]="guardandoModalidad() || estado.modalidadesDisponibles.length === 0">
        {{ guardandoModalidad() ? 'Guardando...' : 'Guardar modalidad' }}
      </button>
    </div>

    <small *ngIf="loadingModalidad()">Validando modalidad actual...</small>
  </article>

  <div class="grid">
    <article class="card" [class.card-disabled]="!tieneModalidadSeleccionada">
      <h2>Paso 2: Nueva propuesta</h2>
      <label>Tema sugerido por comisión
        <select [(ngModel)]="form.idTema" (ngModelChange)="onSeleccionTema()" [disabled]="!tieneModalidadSeleccionada">
          <option [ngValue]="null">-- Selecciona un tema --</option>
          <option *ngFor="let t of temasDisponibles()" [ngValue]="t.idTema">
            {{ t.titulo }} ({{ t.carrera }})
          </option>
        </select>
      </label>
      <small *ngIf="loadingTemas()">Cargando temas disponibles...</small>
      <small *ngIf="!loadingTemas() && temasDisponibles().length === 0">No hay temas cargados por la comisión para tu carrera.</small>

      <label>Carrera (id)
        <input type="number" [(ngModel)]="form.idCarrera" min="1" [disabled]="!tieneModalidadSeleccionada" />
      </label>
      <label>Título
        <input type="text" [(ngModel)]="form.titulo" [disabled]="!tieneModalidadSeleccionada" />
      </label>
      <label>Tema de investigación
        <textarea rows="2" [(ngModel)]="form.temaInvestigacion" [disabled]="!tieneModalidadSeleccionada"></textarea>
      </label>
      <label>Planteamiento del problema
        <textarea rows="3" [(ngModel)]="form.planteamientoProblema" [disabled]="!tieneModalidadSeleccionada"></textarea>
      </label>
      <label>Objetivos generales
        <textarea rows="2" [(ngModel)]="form.objetivosGenerales" [disabled]="!tieneModalidadSeleccionada"></textarea>
      </label>
      <label>Objetivos específicos
        <textarea rows="3" [(ngModel)]="form.objetivosEspecificos" [disabled]="!tieneModalidadSeleccionada"></textarea>
      </label>
      <label>Metodología
        <textarea rows="2" [(ngModel)]="form.metodologia" [disabled]="!tieneModalidadSeleccionada"></textarea>
      </label>
      <label>Resultados esperados
        <textarea rows="2" [(ngModel)]="form.resultadosEsperados" [disabled]="!tieneModalidadSeleccionada"></textarea>
      </label>
      <label>Bibliografía
        <textarea rows="2" [(ngModel)]="form.bibliografia" [disabled]="!tieneModalidadSeleccionada"></textarea>
      </label>
      <small class="warn-inline" *ngIf="!tieneModalidadSeleccionada">Debes registrar tu modalidad antes de enviar tu propuesta.</small>
      <button class="btn primary" (click)="enviar()" [disabled]="saving() || !tieneModalidadSeleccionada">Enviar propuesta</button>
    </article>

    <article class="card">
      <h2>Mis propuestas</h2>
      <button class="btn secondary" (click)="cargarHistorial()" [disabled]="loading()">Recargar historial</button>
      <button class="btn secondary" (click)="cargarTemasDisponibles()" [disabled]="loadingTemas()">Recargar temas</button>
      <div class="empty" *ngIf="!loading() && historial().length === 0">Aún no has enviado propuestas.</div>
      <ul class="list" *ngIf="historial().length > 0">
        <li *ngFor="let p of historial()">
          <strong>{{ p.titulo }}</strong>
          <p>{{ p.tema || 'Sin tema' }}</p>
          <small>Estado: {{ p.estado }} · {{ p.fechaEnvio || 'Sin fecha' }}</small>
          <p *ngIf="p.observaciones"><em>Observación: {{ p.observaciones }}</em></p>
        </li>
      </ul>
    </article>
  </div>
</section>
